<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject Dashboard - IA-MARKS MANAGEMENT</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDmvzNuE-szbAkFjeEjCNFJK-65sC0_IfE",
            authDomain: "smart-attendance-a9ab4.firebaseapp.com",
            projectId: "smart-attendance-a9ab4",
            storageBucket: "smart-attendance-a9ab4.firebasestorage.app",
            messagingSenderId: "447867381654",
            appId: "1:447867381654:web:e27e6cceb8c63c0c799fb7",
            measurementId: "G-19HPME0K12"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        let currentUser = null;
        let currentSubjectId = null;
        let students = [];
        let allStudents = []; // Store all students for search filtering
        let isEditMode = false; // Track if we're in edit mode
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Subject Dashboard loading...');
            console.log('üìç Current URL:', window.location.href);
            
            // Get subject ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            currentSubjectId = urlParams.get('subjectId');
            
            console.log('üîç Subject ID from URL:', currentSubjectId);
            console.log('üîç All URL params:', Object.fromEntries(urlParams));
            
            // Show loading state immediately
            document.getElementById('subjectName').textContent = 'Loading subject...';
            
            if (!currentSubjectId || currentSubjectId === 'undefined' || currentSubjectId === 'null') {
                console.error('‚ùå No valid subject ID provided');
                showAlert('error', 'No subject ID provided. Redirecting to dashboard...');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 3000);
                return;
            }
            
            // Validate ObjectId format
            if (!currentSubjectId.match(/^[0-9a-fA-F]{24}$/)) {
                console.error('‚ùå Invalid subject ID format:', currentSubjectId);
                showAlert('error', 'Invalid subject ID format. Redirecting to dashboard...');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 3000);
                return;
            }
            
            console.log('‚úÖ Valid subject ID, initializing dashboard...');
            initializeSubjectDashboard();
        });
        
        function initializeSubjectDashboard() {
            // Listen for authentication state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    console.log('‚úÖ User authenticated:', user.email);
                    
                    // Display user information
                    displayUserInfo(user);
                    
                    // Load subject data and students
                    await loadSubjectData();
                    
                    // Initialize UI handlers
                    initializeUIHandlers();
                    
                } else {
                    console.log('‚ùå No user authenticated, redirecting to login');
                    window.location.href = '/';
                }
            });
        }
        
        function displayUserInfo(user) {
            const email = user.email;
            const displayName = user.displayName || email.split('@')[0];
            
            document.getElementById('userEmail').textContent = email;
            
            // Update profile button
            const profileBtn = document.getElementById('profileBtn');
            if (user.photoURL) {
                profileBtn.innerHTML = `<img src="${user.photoURL}" alt="Profile" class="w-8 h-8 rounded-lg object-cover">`;
            } else {
                const initials = displayName.substring(0, 2).toUpperCase();
                profileBtn.innerHTML = `<span class="text-sm font-bold">${initials}</span>`;
            }
        }
        
        async function loadSubjectData() {
            try {
                console.log('üì° Starting to load subject data...');
                showAlert('info', 'Loading subject data...');
                
                const idToken = await currentUser.getIdToken();
                console.log('üîë Got Firebase ID token');
                
                const apiUrl = `/api/teachers/subject/${currentSubjectId}/students`;
                console.log('üì° Making API call to:', apiUrl);
                
                // Fetch students for this subject
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° API Response status:', response.status);
                console.log('üì° API Response headers:', Object.fromEntries(response.headers));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error Response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('üìä API Response data:', data);
                
                if (data.success) {
                    console.log('‚úÖ Subject data loaded successfully:', data.data);
                    
                    // Update page title and subject info
                    document.getElementById('subjectName').textContent = data.data.subjectName || 'Unknown Subject';
                    document.getElementById('studentCount').textContent = data.data.studentCount || 0;
                    document.title = `${data.data.subjectName || 'Subject'} - Subject Dashboard`;
                    
                    students = data.data.students || [];
                    allStudents = [...students]; // Store all students for search
                    
                    console.log('üë• Found', students.length, 'students');
                    
                    if (students.length > 0) {
                        console.log('üìã Showing students table');
                        showStudentsTable();
                        renderStudentsTable(students);
                    } else {
                        console.log('üì§ Showing upload section (no students)');
                        showUploadSection();
                    }
                    
                    hideAlert();
                } else {
                    console.error('‚ùå API returned success=false:', data);
                    throw new Error(data.error || 'Failed to load subject data');
                }
                
            } catch (error) {
                console.error('‚ùå Error loading subject data:', error);
                console.error('‚ùå Error stack:', error.stack);
                
                // Show detailed error message
                const errorMsg = error.message.includes('Failed to fetch') 
                    ? 'Network error - please check your connection and try again'
                    : `Failed to load subject data: ${error.message}`;
                    
                showAlert('error', errorMsg);
                
                // Show error state in UI
                document.getElementById('subjectName').textContent = 'Error loading subject';
                document.getElementById('studentCount').textContent = '0';
            }
        }
        
        function showUploadSection() {
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('studentsSection').classList.add('hidden');
        }
        
        function showStudentsTable() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('studentsSection').classList.remove('hidden');
        }
        
        function renderStudentsTable(studentsData) {
            const tableBody = document.getElementById('studentsTableBody');
            tableBody.innerHTML = '';
            
            studentsData.forEach((student, index) => {
                const row = createStudentRow(student, index);
                tableBody.appendChild(row);
            });
        }
        
        function createStudentRow(student, index) {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 hover:bg-gray-50';
            
            const marks = student.marks || {
                C1: { test1: null, scaledDown: null, activity: null, total: null },
                C2: { test2: null, scaledDown: null, activity: null, total: null },
                grandTotal: null
            };
            
            row.innerHTML = `
                <td class="px-4 py-3 text-center font-medium">${index + 1}</td>
                <td class="px-4 py-3 font-medium">${student.uucmsRegNo}</td>
                <td class="px-4 py-3">${student.name}</td>
                
                <!-- C1 Section -->
                <td class="px-2 py-3 text-center">
                    <input type="number" 
                           class="mark-input w-16 px-2 py-1 text-center border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           value="${marks.C1.test1 || ''}" 
                           onchange="updateMark(${index}, 'C1.test1', this.value)"
                           min="0" max="20" ${!isEditMode ? 'disabled' : ''}>
                </td>
                <td class="px-2 py-3 text-center">
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded font-medium">${marks.C1.scaledDown || '-'}</span>
                </td>
                <td class="px-2 py-3 text-center">
                    <input type="number" 
                           class="mark-input w-16 px-2 py-1 text-center border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           value="${marks.C1.activity || ''}" 
                           onchange="updateMark(${index}, 'C1.activity', this.value)"
                           min="0" max="10" ${!isEditMode ? 'disabled' : ''}>
                </td>
                <td class="px-2 py-3 text-center">
                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded font-bold">${marks.C1.total || '-'}</span>
                </td>
                
                <!-- C2 Section -->
                <td class="px-2 py-3 text-center">
                    <input type="number" 
                           class="mark-input w-16 px-2 py-1 text-center border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           value="${marks.C2.test2 || ''}" 
                           onchange="updateMark(${index}, 'C2.test2', this.value)"
                           min="0" max="20" ${!isEditMode ? 'disabled' : ''}>
                </td>
                <td class="px-2 py-3 text-center">
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded font-medium">${marks.C2.scaledDown || '-'}</span>
                </td>
                <td class="px-2 py-3 text-center">
                    <input type="number" 
                           class="mark-input w-16 px-2 py-1 text-center border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           value="${marks.C2.activity || ''}" 
                           onchange="updateMark(${index}, 'C2.activity', this.value)"
                           min="0" max="10" ${!isEditMode ? 'disabled' : ''}>
                </td>
                <td class="px-2 py-3 text-center">
                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded font-bold">${marks.C2.total || '-'}</span>
                </td>
                
                <!-- Grand Total -->
                <td class="px-4 py-3 text-center">
                    <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-lg font-bold text-lg">${marks.grandTotal || '-'}</span>
                </td>
            `;
            
            return row;
        }
        
        // Global function to update marks
        window.updateMark = async function(studentIndex, markType, value) {
            try {
                const numValue = value === '' ? null : parseFloat(value);
                
                const idToken = await currentUser.getIdToken();
                
                const response = await fetch(`/api/teachers/subject/${currentSubjectId}/student/${studentIndex}/marks`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        markType: markType,
                        value: numValue
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Update the student data locally
                    students[studentIndex] = result.data.student;
                    
                    // Re-render the specific row to show updated calculations
                    const tableBody = document.getElementById('studentsTableBody');
                    const rows = tableBody.getElementsByTagName('tr');
                    const newRow = createStudentRow(students[studentIndex], studentIndex);
                    tableBody.replaceChild(newRow, rows[studentIndex]);
                    
                    // Show success feedback briefly
                    showAlert('success', 'Marks updated successfully', 2000);
                } else {
                    throw new Error('Failed to update marks');
                }
                
            } catch (error) {
                console.error('Error updating marks:', error);
                showAlert('error', 'Failed to update marks. Please try again.');
            }
        }
        
        function initializeUIHandlers() {
            // File upload handler
            const fileInput = document.getElementById('studentFile');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadForm = document.getElementById('uploadForm');
            const fileName = document.getElementById('fileName');
            
            // Show selected file name
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    fileName.textContent = `Selected: ${this.files[0].name}`;
                    fileName.classList.remove('hidden');
                } else {
                    fileName.classList.add('hidden');
                }
            });
            
            uploadForm.addEventListener('submit', handleFileUpload);
            
            // Back to dashboard button
            document.getElementById('backToDashboard').addEventListener('click', () => {
                window.location.href = '/dashboard';
            });
            
            
            // Edit/Save button functionality
            document.getElementById('editSaveBtn').addEventListener('click', toggleEditMode);
            
            // Search functionality
            document.getElementById('studentSearch').addEventListener('input', handleSearch);
            
            // Import Marks button
            document.getElementById('importMarksBtn').addEventListener('click', showImportMarksModal);
        }
        
        async function handleFileUpload(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('studentFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('error', 'Please select a file to upload');
                return;
            }
            
            try {
                showAlert('info', 'Uploading student list...');
                
                const formData = new FormData();
                formData.append('studentFile', file);
                
                const idToken = await currentUser.getIdToken();
                
                const response = await fetch(`/api/teachers/upload-students/${currentSubjectId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', result.message);
                    
                    // Update students data and show table
                    students = result.data.students;
                    allStudents = [...students]; // Store all students for search
                    document.getElementById('studentCount').textContent = result.data.studentCount;
                    
                    showStudentsTable();
                    renderStudentsTable(students);
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                showAlert('error', error.message || 'Failed to upload student list');
            }
        }
        
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editSaveBtn = document.getElementById('editSaveBtn');
            const markInputs = document.querySelectorAll('.mark-input');
            
            if (isEditMode) {
                // Switch to Save mode
                editSaveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save';
                editSaveBtn.className = 'px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors';
                
                // Enable all mark inputs
                markInputs.forEach(input => {
                    input.disabled = false;
                    input.classList.remove('bg-gray-100');
                });
                
                showAlert('info', 'Edit mode enabled. You can now modify marks.');
            } else {
                // Switch to Edit mode
                editSaveBtn.innerHTML = '<i class="fas fa-edit mr-2"></i>Edit';
                editSaveBtn.className = 'px-4 py-2 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition-colors';
                
                // Disable all mark inputs
                markInputs.forEach(input => {
                    input.disabled = true;
                    input.classList.add('bg-gray-100');
                });
                
                showAlert('success', 'Changes saved successfully!');
            }
        }
        
        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                // Show all students
                renderStudentsTable(allStudents);
            } else {
                // Filter students by UUCMS Reg No or Name
                const filteredStudents = allStudents.filter(student => 
                    student.uucmsRegNo.toLowerCase().includes(searchTerm) ||
                    student.name.toLowerCase().includes(searchTerm)
                );
                
                renderStudentsTable(filteredStudents);
                
                // Show search results count
                if (filteredStudents.length === 0) {
                    showAlert('info', 'No students found matching your search.', 3000);
                }
            }
        }
        
        function showImportMarksModal() {
            // Create modal HTML
            const modalHTML = `
                <div id="importMarksModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-upload text-orange-600 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-2">Import Marks</h3>
                            <p class="text-gray-600">Upload a CSV file with student marks</p>
                        </div>
                        
                        <form id="importMarksForm" class="space-y-4">
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-orange-500 transition-colors">
                                <input type="file" id="marksFile" name="marksFile" accept=".csv,.xlsx,.xls" class="hidden">
                                <label for="marksFile" class="cursor-pointer">
                                    <div class="text-center">
                                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                        <p class="text-lg font-medium text-gray-900 mb-2">Choose marks file</p>
                                        <p class="text-sm text-gray-600">CSV or Excel files only</p>
                                        <div id="marksFileName" class="mt-2 text-sm text-orange-600 font-medium hidden"></div>
                                    </div>
                                </label>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-900 mb-2">Required File Format:</h4>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    <li>‚Ä¢ Column 1: UUCMS Registration Number</li>
                                    <li>‚Ä¢ Column 2: Student Name</li>
                                    <li>‚Ä¢ Column 3: Test 1 Marks (C1)</li>
                                    <li>‚Ä¢ Column 4: Activity Marks (C1)</li>
                                    <li>‚Ä¢ Column 5: Test 2 Marks (C2)</li>
                                    <li>‚Ä¢ Column 6: Activity Marks (C2)</li>
                                    <li class="text-orange-600 font-medium">‚Ä¢ Scaled marks and totals will be calculated automatically</li>
                                </ul>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button type="button" id="cancelImport" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                    Cancel
                                </button>
                                <button type="submit" class="flex-1 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors">
                                    <i class="fas fa-upload mr-2"></i>
                                    Import Marks
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add event listeners
            document.getElementById('marksFile').addEventListener('change', function() {
                const fileName = document.getElementById('marksFileName');
                if (this.files && this.files[0]) {
                    fileName.textContent = `Selected: ${this.files[0].name}`;
                    fileName.classList.remove('hidden');
                } else {
                    fileName.classList.add('hidden');
                }
            });
            
            document.getElementById('cancelImport').addEventListener('click', closeImportMarksModal);
            document.getElementById('importMarksForm').addEventListener('submit', handleMarksImport);
            
            // Close modal when clicking outside
            document.getElementById('importMarksModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeImportMarksModal();
                }
            });
        }
        
        function closeImportMarksModal() {
            const modal = document.getElementById('importMarksModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function handleMarksImport(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('marksFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('error', 'Please select a file to upload');
                return;
            }
            
            try {
                showAlert('info', 'Importing marks...');
                
                const formData = new FormData();
                formData.append('marksFile', file);
                
                const idToken = await currentUser.getIdToken();
                
                const response = await fetch(`/api/teachers/import-marks/${currentSubjectId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', result.message);
                    closeImportMarksModal();
                    
                    // Refresh the page data
                    await loadSubjectData();
                } else {
                    throw new Error(result.error || 'Import failed');
                }
                
            } catch (error) {
                console.error('Import error:', error);
                showAlert('error', error.message || 'Failed to import marks');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
                showAlert('error', 'Failed to sign out');
            }
        }
        
        // Utility functions
        function showAlert(type, message, duration = 5000) {
            const alertDiv = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');
            
            let bgColor, textColor, icon;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100 border-green-400';
                    textColor = 'text-green-700';
                    icon = 'fas fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-100 border-red-400';
                    textColor = 'text-red-700';
                    icon = 'fas fa-exclamation-circle';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-blue-100 border-blue-400';
                    textColor = 'text-blue-700';
                    icon = 'fas fa-info-circle';
            }
            
            alertDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm border ${bgColor} ${textColor}`;
            alertText.innerHTML = `<i class="${icon} mr-2"></i>${message}`;
            
            alertDiv.classList.remove('hidden');
            
            if (type !== 'error') {
                setTimeout(() => {
                    hideAlert();
                }, duration);
            }
        }
        
        function hideAlert() {
            document.getElementById('alertMessage').classList.add('hidden');
        }
    </script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#6366f1',
                        'primary-dark': '#4f46e5',
                        'accent': '#8b5cf6',
                        'light-gray': '#f8fafc',
                        'text-gray': '#64748b'
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-light-gray">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-100 fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Left side - Back button and Subject Info -->
                <div class="flex items-center space-x-4">
                    <button id="backToDashboard" class="flex items-center text-gray-600 hover:text-gray-900 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Dashboard
                    </button>
                    <div class="h-6 border-l border-gray-300"></div>
                    <div>
                        <h1 id="subjectName" class="text-lg font-semibold text-gray-900">Loading...</h1>
                        <p class="text-sm text-text-gray">Subject Dashboard</p>
                    </div>
                </div>

                <!-- Right side - User Info -->
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p id="userEmail" class="text-sm font-medium text-gray-900">Loading...</p>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button id="profileBtn" class="w-10 h-10 bg-gradient-to-r from-primary to-accent rounded-xl flex items-center justify-center text-white font-medium hover:shadow-lg transition-all duration-200">
                            <i class="fas fa-user"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pt-24">
        <!-- Subject Info Card -->
        <div class="bg-white rounded-2xl shadow-sm p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 mb-1">Student Management</h2>
                    <p class="text-sm text-text-gray">Manage students and IA marks for this subject</p>
                </div>
                <div class="text-center">
                    <div class="w-16 h-16 bg-primary rounded-2xl flex items-center justify-center mb-2">
                        <span id="studentCount" class="text-2xl font-bold text-white">0</span>
                    </div>
                    <p class="text-sm text-text-gray">Students</p>
                </div>
            </div>
        </div>

        <!-- Upload Section (shown when no students) -->
        <div id="uploadSection" class="bg-white rounded-2xl shadow-sm p-8 text-center">
            <div class="max-w-md mx-auto">
                <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-upload text-3xl text-blue-600"></i>
                </div>
                
                <h3 class="text-2xl font-semibold text-gray-900 mb-4">Upload Student List</h3>
                <p class="text-text-gray mb-8">Upload a CSV or Excel file containing student information (UUCMS Reg No, Name, Phone)</p>
                
                <form id="uploadForm" class="space-y-6">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-primary transition-colors">
                        <input type="file" id="studentFile" name="studentFile" accept=".csv,.xlsx,.xls" class="hidden">
                        <label for="studentFile" class="cursor-pointer">
                            <div class="text-center">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-lg font-medium text-gray-900 mb-2">Choose file to upload</p>
                                <p class="text-sm text-text-gray">CSV or Excel files only (Max 5MB)</p>
                                <div id="fileName" class="mt-2 text-sm text-primary font-medium hidden"></div>
                            </div>
                        </label>
                    </div>
                    
                    <button type="submit" id="uploadBtn" class="w-full bg-primary hover:bg-primary-dark text-white font-medium py-3 px-6 rounded-lg transition-colors">
                        <i class="fas fa-upload mr-2"></i>
                        Upload Student List
                    </button>
                </form>
                
                <div class="mt-6 text-left">
                    <h4 class="font-semibold text-gray-900 mb-2">File Format Requirements:</h4>
                    <ul class="text-sm text-text-gray space-y-1">
                        <li>‚Ä¢ Column 1: UUCMS Registration Number</li>
                        <li>‚Ä¢ Column 2: Student Name</li>
                        <li>‚Ä¢ Column 3: Phone Number</li>
                        <li>‚Ä¢ First row can be headers (will be automatically detected)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Students Table Section (shown when students exist) -->
        <div id="studentsSection" class="hidden">
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">IA Marks Entry</h3>
                        <div class="flex items-center space-x-3">
                            <button id="editSaveBtn" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition-colors">
                                <i class="fas fa-edit mr-2"></i>
                                Edit
                            </button>
                            <button id="importMarksBtn" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white font-medium rounded-lg transition-colors">
                                <i class="fas fa-upload mr-2"></i>
                                Import Marks
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search Bar -->
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="studentSearch" placeholder="Search by UUCMS Reg No or Name..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th rowspan="2" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">SL.NO</th>
                                <th rowspan="2" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">UUCMS REG NO</th>
                                <th rowspan="2" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">NAME</th>
                                <th colspan="4" class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">C1</th>
                                <th colspan="4" class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">C2</th>
                                <th rowspan="2" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Grand Total</th>
                            </tr>
                            <tr>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase border-r border-gray-200">Test 1<br><span class="text-xs normal-case">(20 Marks)</span></th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase border-r border-gray-200">Scaled<br><span class="text-xs normal-case">(10 Marks)</span></th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase border-r border-gray-200">Activity<br><span class="text-xs normal-case">(10 Marks)</span></th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase border-r border-gray-200">Total C1</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase border-r border-gray-200">Test 2<br><span class="text-xs normal-case">(20 Marks)</span></th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase border-r border-gray-200">Scaled<br><span class="text-xs normal-case">(10 Marks)</span></th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase border-r border-gray-200">Activity<br><span class="text-xs normal-case">(10 Marks)</span></th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase border-r border-gray-200">Total C2</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Student rows will be dynamically generated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Alert Message -->
    <div id="alertMessage" class="hidden fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm">
        <p id="alertText" class="text-sm font-medium"></p>
    </div>
</body>
</html>